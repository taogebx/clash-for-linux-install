# 代理作用范围说明

## 重要概念

`clashon`/`clashoff` 命令实际上做了**两件事**，作用范围不同：

### 1. Systemd 服务（系统级别）

**作用范围：整个服务器**

```bash
# clashon 会执行
sudo systemctl start mihomo

# clashoff 会执行
sudo systemctl stop mihomo
```

**特点：**
- ✅ **系统级别**：一旦启动，整个服务器的所有程序都可以使用
- ✅ **持久化**：服务在后台运行，不依赖终端
- ✅ **全局可用**：任何程序都可以连接到 `127.0.0.1:7893` 使用代理
- ✅ **开机自启**：如果服务已启用，系统重启后会自动启动

**验证方法：**
```bash
# 查看服务状态
systemctl status mihomo

# 查看进程
ps aux | grep mihomo

# 查看端口监听
ss -tlnp | grep 7893
```

### 2. 环境变量（终端级别）

**作用范围：当前终端会话**

```bash
# clashon 会设置
export http_proxy=http://127.0.0.1:7893
export https_proxy=http://127.0.0.1:7893
# ... 其他环境变量

# clashoff 会清除
unset http_proxy
unset https_proxy
# ... 清除其他环境变量
```

**特点：**
- ⚠️ **终端级别**：只影响当前终端会话
- ⚠️ **临时性**：关闭终端后环境变量会消失
- ⚠️ **仅当前终端**：其他终端不会自动获得这些环境变量
- ⚠️ **子进程继承**：在当前终端启动的程序会继承这些环境变量

**验证方法：**
```bash
# 查看当前终端的环境变量
echo $http_proxy

# 在新终端中检查（应该没有）
```

---

## 实际效果

### 场景 1：在一个终端执行 `clashon`

**结果：**
1. ✅ **Systemd 服务启动**（系统级别）
   - 整个服务器的所有程序都可以使用代理
   - 服务在后台运行，不依赖终端

2. ✅ **当前终端设置环境变量**（终端级别）
   - 当前终端的程序会自动使用代理
   - 其他终端不会自动获得环境变量

**示例：**
```bash
# 终端 A
clashon
# 服务启动 ✅
# 终端 A 的环境变量设置 ✅

# 终端 B（新打开的）
echo $http_proxy
# 输出：空（没有环境变量）
# 但是服务在运行，可以手动使用代理
```

### 场景 2：在一个终端执行 `clashoff`

**结果：**
1. ✅ **Systemd 服务停止**（系统级别）
   - 整个服务器的代理服务停止
   - 所有程序都无法使用代理

2. ✅ **当前终端清除环境变量**（终端级别）
   - 当前终端的环境变量被清除

**注意：**
- 如果服务停止，即使其他终端有环境变量，也无法使用代理（因为服务已停止）

---

## 详细说明

### Systemd 服务（系统级别）

**服务文件：** `/etc/systemd/system/mihomo.service`

```ini
[Service]
Type=simple
Restart=always
ExecStart=/opt/clash/bin/mihomo -d /opt/clash -f /opt/clash/runtime.yaml
```

**特点：**
- 服务在后台运行，不依赖任何终端
- 监听 `127.0.0.1:7893`，所有程序都可以连接
- 如果配置了 `Restart=always`，服务崩溃会自动重启
- 如果启用了开机自启，系统重启后会自动启动

**使用方式：**
```bash
# 任何程序都可以直接连接代理
curl --proxy http://127.0.0.1:7893 https://www.google.com

# 或者设置环境变量后使用
export http_proxy=http://127.0.0.1:7893
curl https://www.google.com
```

### 环境变量（终端级别）

**环境变量列表：**
```bash
http_proxy=http://127.0.0.1:7893
https_proxy=http://127.0.0.1:7893
HTTP_PROXY=http://127.0.0.1:7893
HTTPS_PROXY=http://127.0.0.1:7893
all_proxy=socks5://127.0.0.1:7893
ALL_PROXY=socks5://127.0.0.1:7893
no_proxy=localhost,127.0.0.1,::1
NO_PROXY=localhost,127.0.0.1,::1
```

**特点：**
- 只影响当前终端会话
- 子进程会继承这些环境变量
- 关闭终端后环境变量会消失
- 其他终端不会自动获得这些环境变量

**使用方式：**
```bash
# 设置了环境变量后，程序会自动使用代理
curl https://www.google.com  # 自动使用代理

# 临时不使用代理
curl --noproxy "*" https://www.google.com
```

---

## 常见场景

### 场景 1：服务运行，但终端没有环境变量

```bash
# 终端 A：服务已启动，但没有环境变量
systemctl status mihomo  # active (running)
echo $http_proxy  # 空

# 可以使用代理，但需要手动指定
curl --proxy http://127.0.0.1:7893 https://www.google.com

# 或者设置环境变量
export http_proxy=http://127.0.0.1:7893
curl https://www.google.com
```

### 场景 2：服务运行，终端有环境变量

```bash
# 终端 A：服务已启动，且有环境变量
systemctl status mihomo  # active (running)
echo $http_proxy  # http://127.0.0.1:7893

# 程序自动使用代理
curl https://www.google.com  # 自动使用代理
```

### 场景 3：服务停止

```bash
# 无论终端是否有环境变量，都无法使用代理
systemctl status mihomo  # inactive (dead)
curl https://www.google.com  # 失败（服务未运行）
```

---

## 最佳实践

### 推荐方式

1. **保持服务运行**
   ```bash
   # 启动服务（系统级别）
   sudo systemctl start mihomo
   
   # 或者使用 clashon（会同时启动服务和设置环境变量）
   clashon
   ```

2. **在需要代理的终端设置环境变量**
   ```bash
   # 方法一：使用 clashon（推荐）
   clashon
   
   # 方法二：手动设置
   export http_proxy=http://127.0.0.1:7893
   export https_proxy=http://127.0.0.1:7893
   ```

3. **在不需要代理的终端不设置环境变量**
   ```bash
   # 服务可以运行，但不设置环境变量
   # 程序就不会自动使用代理
   ```

### 不推荐方式

1. **频繁启动/停止服务**
   - 服务启动/停止会影响整个服务器
   - 其他程序可能正在使用代理

2. **依赖环境变量但不启动服务**
   - 环境变量设置了，但服务未运行
   - 程序会尝试连接代理，但会失败

---

## 总结

| 项目 | Systemd 服务 | 环境变量 |
|------|-------------|---------|
| **作用范围** | 整个服务器 | 当前终端 |
| **持久性** | 持久（后台运行） | 临时（终端关闭后消失） |
| **影响范围** | 所有程序 | 当前终端的程序 |
| **启动方式** | `systemctl start mihomo` | `export http_proxy=...` |
| **停止方式** | `systemctl stop mihomo` | `unset http_proxy` |
| **clashon 作用** | ✅ 启动服务 | ✅ 设置环境变量 |
| **clashoff 作用** | ✅ 停止服务 | ✅ 清除环境变量 |

**关键点：**
- **服务是系统级别的**：一旦启动，整个服务器都可以使用代理
- **环境变量是终端级别的**：只影响当前终端
- **两者配合使用**：服务提供代理能力，环境变量让程序自动使用代理

---

**文档更新时间：** 2025-12-06

