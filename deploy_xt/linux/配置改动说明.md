# 配置改动说明

## 1. Windows 配置修改建议

### 当前配置
文件：`windows/profiles/rwOxlgFUz5Rw.yaml`

```yaml
prepend:
  - 'DST-PORT,22,DIRECT'
  - 'DOMAIN,zeta-inc.cn,DIRECT'
```

### 问题
- 当前使用 `DOMAIN,zeta-inc.cn,DIRECT` 只能精确匹配 `zeta-inc.cn`
- 无法匹配子域名，如 `www.zeta-inc.cn`、`api.zeta-inc.cn` 等

### 建议修改
将 `DOMAIN` 改为 `DOMAIN-SUFFIX`，以匹配所有子域名：

```yaml
prepend:
  - 'DST-PORT,22,DIRECT'
  - 'DOMAIN-SUFFIX,zeta-inc.cn,DIRECT'  # 匹配 *.zeta-inc.cn 及其所有子域名
```

### 修改方法
在 Clash Verge Rev 中：
1. 打开设置 → 配置文件 → 找到对应的配置文件
2. 编辑 `prepend` 部分
3. 将 `DOMAIN,zeta-inc.cn,DIRECT` 改为 `DOMAIN-SUFFIX,zeta-inc.cn,DIRECT`
4. 保存并重启 Clash

---

## 2. mixin.yaml 改动说明

### 文件对比

#### 新版本模板（resources/mixin.yaml）
```yaml
_custom:
  system-proxy:
    enable: true

mixed-port: 7890

external-controller: "0.0.0.0:9090"
external-ui: public
secret:

allow-lan: false
authentication:

rules:
  prefix:
    - DOMAIN,api64.ipify.org,DIRECT
  suffix:

proxies:
  prefix:
  suffix:
  override:

proxy-groups:
  prefix:
  suffix:
  override:

# tun 配置
tun:
  enable: false
  # ...

# DNS 配置
dns:
  enable: true
  # ...
```

#### 当前安装版本（/opt/clash/mixin.yaml）
```yaml
# Web 控制台配置
external-controller: '0.0.0.0:9090'
external-ui: public
secret: 

# tun 配置
tun:
  enable: false
  # ...

# DNS 配置
dns:
  enable: true
  # ...
```

### 差异说明

1. **缺少 `_custom` 部分**
   - 新版本有 `_custom.system-proxy.enable` 用于控制系统代理
   - 当前版本没有，但不影响功能（通过脚本控制）

2. **缺少 `rules.prefix` 部分**
   - 新版本支持 `rules.prefix` 和 `rules.suffix` 用于前置/后置规则
   - 当前版本没有，因为旧版本的合并脚本不支持此格式

3. **缺少 `proxies` 和 `proxy-groups` 部分**
   - 新版本支持代理和策略组的前置/后置/覆盖
   - 当前版本没有，因为旧版本的合并脚本不支持

### 是否需要还原？

**不需要还原**，原因：

1. **当前版本是旧版本安装时的格式**
   - `/opt/clash/mixin.yaml` 是安装时生成的，格式与安装脚本版本匹配
   - 旧版本的合并脚本（`_merge_config_restart`）使用简单的深度合并，不支持 `rules.prefix` 格式

2. **即使更新为新格式也不会生效**
   - 旧版本的合并脚本无法处理 `rules.prefix` 格式
   - 如果添加 `rules.prefix`，会导致配置验证失败

3. **当前配置方式有效**
   - 已通过直接修改 `/opt/clash/config.yaml` 添加规则
   - 规则已生效，服务正常运行

### 如何升级到新版本格式？

如果需要使用新版本的 mixin.yaml 格式，需要：

1. **更新安装脚本到最新版本**
   ```bash
   cd /root/work/code/tools/clash-for-linux-install
   git pull origin master
   ```

2. **重新安装（会保留配置）**
   ```bash
   sudo bash install.sh
   ```

3. **或者手动更新合并脚本**
   - 更新 `/opt/clash/script/clashctl.sh` 中的 `_merge_config_restart` 函数
   - 使用新版本的合并逻辑

### 当前配置状态

- ✅ `/opt/clash/mixin.yaml`：旧版本格式，正常工作
- ✅ `/opt/clash/config.yaml`：已添加 `DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接` 规则
- ✅ `/opt/clash/runtime.yaml`：合并后的配置，规则已生效
- ✅ 服务运行正常

---

## 3. 配置改动总结

### Linux 服务器改动

1. **添加自定义规则**
   - 文件：`/opt/clash/config.yaml`
   - 位置：第 1555 行（rules 列表最前面）
   - 内容：`DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接`
   - 状态：✅ 已生效

2. **更新订阅配置**
   - 使用 Windows 配置文件更新
   - 订阅链接已保存到 `/opt/clash/url`
   - 状态：✅ 已更新

3. **升级内核版本**
   - 从 `v1.19.2` 升级到 `v1.19.17`
   - 状态：✅ 已升级

### Windows 配置建议

- 文件：`windows/profiles/rwOxlgFUz5Rw.yaml`
- 建议：将 `DOMAIN,zeta-inc.cn,DIRECT` 改为 `DOMAIN-SUFFIX,zeta-inc.cn,DIRECT`
- 原因：匹配所有子域名（`*.zeta-inc.cn`）

### mixin.yaml 状态

- 当前格式：旧版本格式（与安装脚本版本匹配）
- 是否需要还原：❌ 不需要
- 原因：旧版本格式正常工作，新版本格式当前不支持

---

**文档更新时间：** 2025-12-06

