# Clash for Linux 部署与配置文档

## 目录
1. [安装部署](#安装部署)
2. [配置更新](#配置更新)
3. [自定义规则配置](#自定义规则配置)
4. [常见问题](#常见问题)
5. [配置改动记录](#配置改动记录)

---

## 安装部署

### 环境要求
- 操作系统：Linux（支持 systemd）
- 用户权限：root 或 sudo 用户
- Shell 支持：bash、zsh、fish

### 一键安装

```bash
git clone --branch master --depth 1 https://gh-proxy.com/https://github.com/nelvko/clash-for-linux-install.git \
  && cd clash-for-linux-install \
  && sudo bash install.sh
```

### 安装过程说明

1. **安装脚本会执行以下操作：**
   - 下载并安装 mihomo 内核（或 clash 内核）
   - 安装必要的工具（yq、subconverter）
   - 配置 systemd 服务
   - 设置开机自启
   - 配置 Shell 自动加载脚本

2. **安装路径：**
   - 主目录：`/opt/clash`
   - 二进制文件：`/opt/clash/bin/`
   - 配置文件：`/opt/clash/config.yaml`（原始订阅配置）
   - 运行时配置：`/opt/clash/runtime.yaml`（合并后的配置）
   - 自定义配置：`/opt/clash/mixin.yaml`（用户自定义配置）

3. **系统服务：**
   - 服务名称：`mihomo.service`（或 `clash.service`）
   - 服务文件：`/etc/systemd/system/mihomo.service`
   - 开机自启：已启用

---

## 配置更新

### 方式一：使用 clashupdate 命令（推荐）

```bash
# 加载脚本
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh

# 更新订阅（使用新链接）
clashupdate https://你的订阅链接

# 更新订阅（使用保存的链接）
clashupdate

# 查看更新日志
clashupdate log

# 设置定时自动更新（每2天更新一次）
clashupdate auto https://你的订阅链接
```

**优点：**
- 自动下载最新订阅
- 自动验证配置有效性
- 自动备份旧配置
- 自动重启服务
- 支持订阅转换（如果需要）
- 自动保存订阅链接

### 方式二：手动复制配置文件

如果订阅链接无法访问（如返回 404），可以从 Windows 客户端复制配置文件：

```bash
# 1. 从 Windows 复制配置文件到服务器
# 例如：scp /path/to/RadOvx6kcGcN.yaml root@server:/tmp/

# 2. 备份当前配置
sudo cp /opt/clash/config.yaml /opt/clash/config.yaml.backup.$(date +%Y%m%d_%H%M%S)

# 3. 复制新配置
sudo cp /tmp/RadOvx6kcGcN.yaml /opt/clash/config.yaml

# 4. 保存订阅链接（可选）
echo "https://你的订阅链接" | sudo tee /opt/clash/url

# 5. 合并配置并重启
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
_merge_config_restart
```

### 方式三：手动下载配置文件

```bash
# 使用 wget 下载（需要代理）
export http_proxy=http://127.0.0.1:7893
export https_proxy=http://127.0.0.1:7893
wget -O /opt/clash/config.yaml "https://你的订阅链接"

# 验证并重启
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
_merge_config_restart
```

---

## 自定义规则配置

### 添加前置规则（域名直连）

#### 方法一：直接修改配置文件（当前使用的方法）

由于当前安装的脚本版本较旧，不支持 `mixin.yaml` 中的 `rules.prefix` 格式，需要直接修改原始配置文件：

```bash
# 1. 找到 rules 部分（通常在 1554 行左右）
grep -n "^rules:" /opt/clash/config.yaml

# 2. 在 rules 列表最前面添加规则
sudo sed -i '1554a\ - DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接' /opt/clash/config.yaml

# 3. 合并配置并重启
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
_merge_config_restart
```

**规则格式说明：**
- `DOMAIN-SUFFIX,zeta-inc.cn,DIRECT`：匹配 `*.zeta-inc.cn` 及其所有子域名
- `DOMAIN,zeta-inc.cn,DIRECT`：仅匹配 `zeta-inc.cn`（不匹配子域名）
- `DOMAIN-KEYWORD,keyword,DIRECT`：匹配包含关键字的域名

#### 方法二：使用 mixin.yaml（新版本支持）

如果使用新版本的安装脚本，可以在 `mixin.yaml` 中配置：

```yaml
rules:
  prefix:
    - DOMAIN-SUFFIX,zeta-inc.cn,DIRECT  # 前置规则
    - DOMAIN,api64.ipify.org,DIRECT     # 用于 clashui 获取真实公网 IP
  suffix:
    # 后置规则（插入到规则列表最后面）
```

然后执行：
```bash
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
_merge_config_restart
```

### 当前已配置的规则

- `DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接`：`*.zeta-inc.cn` 域名直连
- 位置：`/opt/clash/config.yaml` 第 1555 行

---

## 常见问题

### 1. 如何更新内核版本？

```bash
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh

# 升级内核
clashupgrade

# 查看升级日志
clashupgrade -v
```

### 2. 如何开启/关闭代理？

```bash
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh

# 开启代理
clashon

# 关闭代理
clashoff

# 查看状态
clashstatus
```

### 3. 如何关闭自动开启代理？

编辑 `~/.bashrc`，找到并注释掉 `watch_proxy`：

```bash
# 原配置
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh && watch_proxy

# 修改为（保留命令但关闭自动开启）
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
# watch_proxy  # 注释掉自动开启功能
```

### 4. 订阅链接返回 404 怎么办？

可能原因：
- 订阅链接需要从 Windows 客户端通过代理访问
- 订阅链接已失效或过期
- 订阅服务需要特殊认证

解决方案：
- 从 Windows 客户端下载最新配置文件
- 手动复制到 Linux 服务器
- 使用 `clashupdate` 命令更新

### 5. 设备数量限制问题

- 设备数量限制由服务端控制，不是配置文件限制
- 配置文件可以复制到多台设备
- 同时在线设备数不能超过套餐限制（如 3 个设备）
- 超过限制时，新设备可能无法连接或旧设备被踢下线

---

## 配置改动记录

### 2025-12-06 配置改动

#### 1. 添加自定义规则

**改动内容：**
- 在 `/opt/clash/config.yaml` 的 rules 列表最前面添加了 `DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接`

**改动位置：**
- 文件：`/opt/clash/config.yaml`
- 行号：第 1555 行（在 rules 列表最前面）

**改动原因：**
- 需要让 `*.zeta-inc.cn` 域名直连，不经过代理

**验证方法：**
```bash
grep -i "zeta" /opt/clash/runtime.yaml
# 应该输出：- "DOMAIN-SUFFIX,zeta-inc.cn,\U0001F9F1直接连接"
```

#### 2. 更新订阅配置

**改动内容：**
- 使用 Windows 配置文件 `RadOvx6kcGcN.yaml` 更新了 Linux 服务器配置
- 订阅链接已保存到 `/opt/clash/url`

**改动位置：**
- 文件：`/opt/clash/config.yaml`
- 文件：`/opt/clash/url`

#### 3. 升级内核版本

**改动内容：**
- 从 `v1.19.2` 升级到 `v1.19.17`

**升级方法：**
```bash
curl -X POST --silent --noproxy "*" --location -H "Authorization: Bearer " "http://127.0.0.1:9090/upgrade?channel="
```

---

## 常用命令速查

```bash
# 加载脚本
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh

# 开启代理
clashon

# 关闭代理
clashoff

# 查看状态
clashstatus

# 查看 Web 控制台
clashui

# 更新订阅
clashupdate [订阅链接]

# 升级内核
clashupgrade

# 查看/编辑 Mixin 配置
clashmixin        # 查看
clashmixin -e     # 编辑

# 查看/修改 Web 密钥
clashsecret       # 查看
clashsecret <密钥> # 修改

# Tun 模式
clashtun          # 查看状态
clashtun on       # 开启
clashtun off      # 关闭
```

---

## 文件结构说明

```
/opt/clash/
├── bin/                    # 二进制文件目录
│   ├── mihomo             # 代理内核
│   ├── yq                 # YAML 处理工具
│   └── subconverter/      # 订阅转换工具
├── config.yaml            # 原始订阅配置
├── runtime.yaml           # 运行时配置（合并后的配置）
├── mixin.yaml             # 自定义配置（用户配置）
├── url                    # 订阅链接
├── script/                # 管理脚本
│   ├── common.sh          # 通用函数
│   └── clashctl.sh        # 控制命令
└── public/                # Web UI 界面
```

---

## 注意事项

1. **配置文件备份：**
   - 修改配置前建议先备份
   - 使用 `clashupdate` 会自动备份

2. **订阅链接：**
   - 订阅链接保存在 `/opt/clash/url`
   - 如果订阅链接无法访问，可以从 Windows 客户端复制配置文件

3. **规则优先级：**
   - 规则按顺序匹配，前面的规则优先
   - 自定义规则应放在规则列表前面

4. **服务管理：**
   - 使用 systemd 管理服务
   - 服务会自动重启（Restart=always）

5. **代理环境变量：**
   - 开启代理后会自动设置 `http_proxy`、`https_proxy` 等环境变量
   - 关闭代理后会自动清除这些变量

---

## 参考链接

- 项目地址：https://github.com/nelvko/clash-for-linux-install
- Clash 知识库：https://clash.wiki/
- mihomo 内核：https://github.com/MetaCubeX/mihomo

---

**文档更新时间：** 2025-12-06  
**维护者：** 系统管理员

