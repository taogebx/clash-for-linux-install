# 更新脚本说明

## 当前状态

- ✅ **内核版本**：v1.19.17（最新）
- ⚠️ **脚本版本**：旧版本（不支持 rules.prefix）
- ✅ **服务状态**：运行正常

## 是否需要更新脚本？

### 不需要更新（推荐）

如果满足以下条件，**不需要更新脚本**：

1. ✅ 当前功能满足需求
2. ✅ 配置已正常工作
3. ✅ 不需要使用 `rules.prefix` 功能

**原因：**
- 内核已经是最新版本
- 服务运行正常
- 配置已生效
- 更新脚本可能带来不必要的风险

### 可以更新（可选）

如果满足以下条件，**可以更新脚本**：

1. 需要使用 `rules.prefix` 功能（在 mixin.yaml 中配置前置规则）
2. 想要新版本的其他功能
3. 愿意承担更新可能带来的风险

## 如何更新脚本（不重新安装）

### 方法一：手动更新脚本文件

```bash
# 1. 备份当前脚本
sudo cp -r /opt/clash/script /opt/clash/script.backup.$(date +%Y%m%d_%H%M%S)

# 2. 复制新版本脚本
sudo cp -r /root/work/code/tools/clash-for-linux-install/script/* /opt/clash/script/

# 3. 验证脚本
source /opt/clash/script/common.sh && source /opt/clash/script/clashctl.sh
clashctl --help
```

### 方法二：重新安装（会保留配置）

```bash
# 1. 备份当前配置
sudo cp /opt/clash/config.yaml /opt/clash/config.yaml.backup
sudo cp /opt/clash/mixin.yaml /opt/clash/mixin.yaml.backup

# 2. 重新运行安装脚本（会保留配置）
cd /root/work/code/tools/clash-for-linux-install
sudo bash install.sh
```

**注意：** 重新安装会：
- ✅ 更新脚本到最新版本
- ✅ 保留现有配置
- ✅ 保留订阅链接
- ⚠️ 可能会覆盖 mixin.yaml（建议先备份）

## 新版本脚本的主要改进

### 1. 支持 rules.prefix 和 rules.suffix

**旧版本：**
```yaml
# mixin.yaml 不支持
rules:
  prefix: []  # 不支持
```

**新版本：**
```yaml
# mixin.yaml 支持
rules:
  prefix:
    - DOMAIN-SUFFIX,zeta-inc.cn,DIRECT  # 前置规则
  suffix:
    - MATCH,PROXY  # 后置规则
```

### 2. 改进的配置合并逻辑

**旧版本：**
- 简单的深度合并
- 不支持规则的前置/后置插入

**新版本：**
- 支持规则的前置/后置插入
- 支持代理和策略组的前置/后置/覆盖
- 更灵活的配置合并

### 3. 新增功能

- 改进的 `clashon` 函数（支持系统代理）
- 改进的 `watch_proxy` 函数
- 更好的错误处理

## 当前配置方式

由于当前脚本版本不支持 `rules.prefix`，我们采用了**直接修改配置文件**的方式：

```bash
# 在 config.yaml 的 rules 列表最前面添加规则
sudo sed -i '1554a\ - DOMAIN-SUFFIX,zeta-inc.cn,🧱直接连接' /opt/clash/config.yaml
```

这种方式：
- ✅ 完全有效
- ✅ 规则已生效
- ✅ 不需要更新脚本

## 建议

**当前建议：不需要更新脚本**

原因：
1. 内核已经是最新版本
2. 服务运行正常
3. 配置已生效
4. 当前配置方式（直接修改 config.yaml）完全有效
5. 更新脚本可能带来不必要的风险

如果将来需要使用 `rules.prefix` 功能，再考虑更新脚本。

---

**文档更新时间：** 2025-12-06

